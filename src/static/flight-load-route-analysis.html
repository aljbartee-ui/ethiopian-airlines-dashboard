// Data persistence functions
function saveDataToLocalStorage(data) {
    try {
        localStorage.setItem('ethiopianAirlinesRouteData', JSON.stringify(data));
        localStorage.setItem('ethiopianAirlinesDataTimestamp', new Date().toISOString());
        console.log('Data saved to localStorage');
    } catch (error) {
        console.error('Error saving to localStorage:', error);
    }
}

function loadDataFromLocalStorage() {
    try {
        const savedData = localStorage.getItem('ethiopianAirlinesRouteData');
        const timestamp = localStorage.getItem('ethiopianAirlinesDataTimestamp');
        
        if (savedData) {
            console.log('Loaded saved data from:', timestamp);
            return JSON.parse(savedData);
        }
    } catch (error) {
        console.error('Error loading from localStorage:', error);
    }
    return null;
}

function clearLocalStorage() {
    localStorage.removeItem('ethiopianAirlinesRouteData');
    localStorage.removeItem('ethiopianAirlinesDataTimestamp');
}

// Update your loadDashboardData function
async function loadDashboardData() {
    try {
        // Try to load from server first
        const response = await fetch('/flight-load/route-analysis/data');
        const result = await response.json();
        
        if (result.success) {
            // Save to localStorage for persistence
            saveDataToLocalStorage(result);
            displayDashboard(result.summary);
            loadCharts();
        } else {
            // Try to load from localStorage if server has no data
            const savedData = loadDataFromLocalStorage();
            if (savedData && savedData.success) {
                displayDashboard(savedData.summary);
                loadCharts();
                showMessage('Loaded previously saved data', 'info');
            } else {
                dashboardContent.innerHTML = `
                    <div class="no-data">
                        <h2>üìä No Data Available</h2>
                        <p>Please upload an Excel file to view route analysis</p>
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        // Fallback to localStorage
        const savedData = loadDataFromLocalStorage();
        if (savedData && savedData.success) {
            displayDashboard(savedData.summary);
            loadCharts();
            showMessage('Loaded previously saved data (offline mode)', 'info');
        } else {
            dashboardContent.innerHTML = `<div class="error">‚ùå Error loading data: ${error.message}</div>`;
        }
    }
}

// Add message display function
function showMessage(message, type = 'info') {
    const messageDiv = document.createElement('div');
    messageDiv.className = type === 'info' ? 'success' : 'error';
    messageDiv.innerHTML = `‚ÑπÔ∏è ${message}`;
    document.getElementById('uploadMessage').appendChild(messageDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 5000);
}
